#!/bin/bash

if [ $(pgrep -cx panel) -gt 1 ] ; then
	printf "%s\n" "The panel is already running." >&2
	exit 1
fi

trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

[ -e "$PANEL_FIFO" ] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"

battery () {
	if which acpi > /dev/null 2>&1;
	then
		while true;
		do
			DATA=$(acpi -b)

			remainder=$(echo $DATA | cut -d" " -f5)
			percent=$(echo $DATA | cut -d" " -f4 | sed 's/,//g')

			echo -n "B"
			echo $DATA | grep "Discharging" > /dev/null
			if [ $? -eq 0 ];
			then
			    echo "$percent% $remainder"
			else
			    echo "$percent% +$remainder"
			fi
			sleep 10
		done
	fi
}
notify_network_loop () {
	while true;
	do
		notify_network
		sleep 5
	done
}

first_time () {
	sleep 1
	echo "H$(hostname)"
	echo "V$($HOME/bin/vol.sh get)"
}

bspc config top_padding $PANEL_HEIGHT
bspc control --subscribe > "$PANEL_FIFO" &
xtitle -sf 'T%s' > "$PANEL_FIFO" &
clock -sf 'S%a %H:%M' > "$PANEL_FIFO" &
battery > "$PANEL_FIFO" &
notify_network_loop > "$PANEL_FIFO" &
first_time > "$PANEL_FIFO" &

. panel_colors

cat "$PANEL_FIFO" | panel_bar | bar-aint-recursive -g x$PANEL_HEIGHT -f "$PANEL_FONT_FAMILY" -F "$COLOR_FOREGROUND" -B "$COLOR_BACKGROUND" &

wait
