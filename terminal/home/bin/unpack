#!/usr/bin/env ruby
require 'json'
require 'English'

# https://www.jvt.me/posts/2020/08/24/sort-recursive-hash-ruby/
def recursive_sort(v, &block)
  if v.class == Hash
    v.sorted_hash(&block)
  elsif v.class == Array
    v.collect {|a| recursive_sort(a, &block)}
  else
    v
  end
end

class Hash
  def sorted_hash(&block)
    self.class[
      self.each do |k,v|
        self[k] = recursive_sort(v, &block)
      end.sort(&block)]
  end
end

def pretty_json(s)
  recursive_sort(JSON.parse(s))
end

content = ARGF.read.strip
if content.start_with?('{') || content.start_with?('[')
  jj pretty_json(content)
  exit 0
elsif content.start_with? '"'
  # https://www.jvt.me/posts/2021/06/28/parse-encoded-json-string-ruby/
  $SAFE = 4
  jj pretty_json(eval content)
  exit 0
elsif content.start_with? 'eyJ' # it's Base64-encoded JSON
  if content.include? '.' # JWT
    puts `jwt <<< #{content}`
    exit 0
  else # Base64-encoded JSON
    require 'base64'
    jj pretty_json(Base64.urlsafe_decode64(content))
    exit 0
  end
elsif content.start_with?('http') || content.start_with?('https')
  out = `url <<< '#{content}'`
  exit $CHILD_STATUS.exitstatus unless $CHILD_STATUS.exitstatus.zero?
  puts out
  exit 0
end

exit 1
