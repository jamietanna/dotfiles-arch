#!/usr/bin/env bash
# vim: foldmethod=marker:foldlevel=0 textwidth=80 wrap
# -----------------------------------------------------------------------------
# .githelpers
# 	Various helper aliases and functions that make using Git that much better
# -----------------------------------------------------------------------------
# Location: $HOME/.githelpers
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# => Timesaving aliases
# -----------------------------------------------------------------------------
# {{{
alias gc="git commit"
alias gcm="git commit --amend"
alias gst="git status"
alias gco="git checkout"
alias gd="git diff"
alias gdc="git diff --cached"
alias ga="git add"
alias gr="git remote"
alias glog="git log --stat"
alias gpull="git pull --rebase"
alias gp="git push"
alias gcm="git commit --amend"
# }}}

# Adapted from https://github.com/garybernhardt/dotfiles/blob/2c2a757f4abd406f6b4e1b328b6382d37f7f9036/.githelpers
function pretty_git_log () {
	local HASH="%C(yellow)%h%Creset"
	local RELATIVE_TIME="%Cgreen(%ar)%Creset"
	local AUTHOR="%C(bold blue)<%an>%Creset"
	local REFS="%C(bold red)%d%Creset"
	local SUBJECT="%s"
	local DELIM='%%'

	local FORMAT="${HASH}${DELIM}${RELATIVE_TIME}${DELIM}${AUTHOR}${DELIM}${REFS} ${SUBJECT}"

	git log --graph --pretty="tformat:${FORMAT}" "$@" |
		# Replace (2 years ago) with (2 years)
		sed -Ee 's/(^[^<]*) ago\)/\1)/' |
		# Replace (2 years, 5 months) with (2 years)
		sed -Ee 's/(^[^<]*), [[:digit:]]+ .*months?\)/\1)/' |
		# Line columns up based on } delimiter
		column -s "$DELIM" -t |
		# Color merge commits specially
		sed -Ee "s/(Merge (branch|remote-tracking branch|pull request) .*$)/$(printf "\033[91m")\1$(printf "\033[0m")/" |
		# Page only if we're asked to.
		if [ -n "$GIT_NO_PAGER" ]; then
			cat
		else
			# Page only if needed.
			less --quit-if-one-screen --no-init --RAW-CONTROL-CHARS --chop-long-lines
		fi
}

function fork_repo_remotes () {
	# Given an upstream repo that's been cloned, update the remotes to point to
	# the origin (fork) and upstrem remotes
	local upstream
	local origin

	upstream="$(git remote show -n origin |\
		sed -n '/Push  URL/p;' |\
		cut -f2- -d: |\
		cut -c2-)"
	origin="$(sed 's/\([a-z]\/\)[^\/]*\(\/\)/\1jamietanna\2/' <<< "$upstream")"

	git remote set-url origin "$origin"
	git remote add upstream "$upstream"
	git fetch
}

alias glg="pretty_git_log"

# get to the top of our git repo
alias gitroot='git rev-parse --show-toplevel'
alias groot='cd $(gitroot)'

# get the remote of a git repo
# NOTE: assumes that the push is the correct repo address
function grv () {
	local remote
	remote="${1:-origin}"
	git remote -v | grep "$remote" | cut -f2 | cut -f1 -d' ' | tail -n1
}

function gpu() {
	local localBranch="$(git rev-parse --abbrev-ref HEAD)"
	local branchToPushTo="${1:-$localBranch}"
	# if we don't already have an upstream, then warn
	if [[ $(git config "branch.${localBranch}.merge") = '' ]]; then
		echo "gpu: This will push to ${branchToPushTo}. Continue? <CR> to continue"
		read
	fi
	git push -u origin "${branchToPushTo}"
}
